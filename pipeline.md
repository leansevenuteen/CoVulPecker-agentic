┌─────────────────────────────────────────────────────────────────────┐
│                        INPUT: Source Code                          │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│  🎯 STAGE 1: CLASSIFIER AGENT                                      │
│  ─────────────────────────────────────────────────────────────────  │
│  • Phân loại code có khả năng chứa lỗ hổng hay không                │     -----> Ở stage này, agent sẽ gọi tool multimodal 
│  • Xác định các pattern nguy hiểm (SQL Injection, XSS, RCE...)     │             deep learning, nhưng hiện tại
│  • Output: label, confidence, detected_patterns                    │             chưa tích hợp mô hình xong. nên là ở
└─────────────────────────────────────────────────────────────────────┘            stage này thì auto label ra vuln nhé.
                                   │
                                   | Call tool detection
                                   | 
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│  🎯 STAGE 2: DETECTION AGENT                                        │
│  ─────────────────────────────────────────────────────────────────  │
│  • Phân tích chi tiết các lỗ hổng trong code                        │
│  • Xác định vị trí, loại, mức độ nghiêm trọng                       │
│  • Nhận feedback từ Critic để cải thiện (nếu có)                    │
└─────────────────────────────────────────────────────────────────────┘
                                   │ 1 - Vuln
                                   | 0 - Clean
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│  🎯 STAGE 3: REASON AGENT                                           │
│  ─────────────────────────────────────────────────────────────────  │
│  • Tạo lý luận chi tiết về lỗ hổng                                  │
│  • Giải thích tại sao code vulnerable                               │
│  • Đề xuất cách khai thác và khắc phục                              │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   |  Vuln Report 
                                   ▼  
┌─────────────────────────────────────────────────────────────────────┐
│  🎯 STAGE 4: CRITIC AGENT                                           │
│  ─────────────────────────────────────────────────────────────────  │
│  • Đánh giá chất lượng phân tích                                    │
│  • Nếu APPROVED → tiếp tục                                          │
│  • Nếu REJECTED → gửi feedback quay lại Detection (max 3 lần)       │
└─────────────────────────────────────────────────────────────────────┘
                    │                              │
           ┌────────┴────────┐                     │
           │   REJECTED?     │                     │
           │   (feedback)    │                     │
           └────────┬────────┘                     │
                    │                              │
                    ▼                              ▼
         ┌──────────────────┐           ┌──────────────────┐
         │ Quay lại Stage 2 │           │    APPROVED      │
         │ với feedback     │           │                  │
         └──────────────────┘           └────────┬─────────┘
                                                 │
                                                 ▼
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│  🎯 STAGE 5: FINAL VERIFICATION                                     │
│  ─────────────────────────────────────────────────────────────────  │
│  • Xác nhận lỗ hổng với PoC đã tạo                                  │
│  • Đánh dấu vulnerability_confirmed = True/False                    │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         OUTPUT: Final Report                        │
│  • Classification result                                            │
│  • Detailed reasoning                                               │
│  • PoC exploit code                                                 │
│  • Verification status                                              │
└─────────────────────────────────────────────────────────────────────┘